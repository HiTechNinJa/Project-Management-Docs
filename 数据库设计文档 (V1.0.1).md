# 数据库设计文档 (V1.0.1)

## 1. 核心数据表

### 1.1 雷达实时轨迹表 (radar_tracking_logs)

存储雷达上报的每一帧有效目标信息。这是数据量最大的表，承载历史回溯和热力图的数据源。

  ----------------------------------------------------------------------------------------------------
  **字段名**        **类型**          **说明**          **备注**
  ----------------- ----------------- ----------------- ----------------------------------------------
  id                BigInt            主键，自增        

  device_mac        Varchar(17)       ESP32 MAC 地址    设备唯一标识

  batch_id          Varchar(32)       批次 ID           同一帧数据的 3 个目标共享此
                                                        ID，便于前端同步渲染

  target_id         TinyInt           目标编号 (1-3)    对应源码 i+1

  pos_x             SmallInt          X 坐标 (mm)       有符号整数，支持负数

  pos_y             SmallInt          Y 坐标 (mm)       

  speed             SmallInt          速度 (cm/s)       

  resolution        SmallInt          距离分辨率 (mm)   通常为 360

  created_at        DateTime(3)       采集时间          **精确到毫秒**，这对轨迹回放的丝滑度至关重要
  ----------------------------------------------------------------------------------------------------

**索引策略 (Index Strategy):**

- **idx_mac_time (联合索引)**: (device_mac, created_at)

  - **目的**:
    极大地加速"历史回溯"功能中按时间范围查询轨迹点的速度。如果没有此索引，在百万级数据量下查询"过去1小时"的数据将导致全表扫描，前端会卡顿。

### 1.2 设备影子表 (device_shadow)

维护设备的"期望状态"与"配置"，是 API
判断是否加速、是否下发指令的核心依据。

  ----------------------------------------------------------------------------------------
  **字段名**        **类型**          **说明**          **备注**
  ----------------- ----------------- ----------------- ----------------------------------
  device_mac        Varchar(17)       主键              

  online_status     Boolean           在线状态          基于心跳判断

  firmware_ver      Varchar(50)       雷达固件版本      例: \"V2.04.23101915\"

  track_mode        Enum              当前追踪模式      \'single\', \'multi\'

  bluetooth_state   Boolean           蓝牙状态          1: On, 0: Off

  zone_config       **JSON**          **\[新增\]        存储前端拖拽生成的 3 个矩形坐标
                                      预警区配置**      \[{x1,y1,x2,y2},\...\]，用于下发
                                                        0x00C2 指令

  active_viewers    **Int**           **\[新增\]        WebSocket 连接计数。\>0 时 API
                                      活跃观察者数**    下发 interval:100，=0 时下发
                                                        interval:1000

  last_heartbeat    DateTime          最后心跳时间      
  ----------------------------------------------------------------------------------------

### 1.3 守卫报警事件表 (guard_events) **[未来版本 - 守卫模式相关，已创建暂不使用]**

专用于存储"守卫模式"下触发的入侵事件，供前端"守卫日志"模块查询。

  ------------------------------------------------------------------------------------------------------------
  **字段名**        **类型**          **说明**          **备注**
  ----------------- ----------------- ----------------- ------------------------------------------------------
  event_id          BigInt            主键，自增        

  device_mac        Varchar(17)       设备 MAC          

  zone_id           TinyInt           触发区域 ID       1, 2, 或 3

  start_time        DateTime          入侵开始时间      

  end_time          DateTime          入侵结束时间      

  duration          Int               持续时长 (秒)     end_time - start_time

  max_speed         SmallInt          期间最大速度      用于判断是人还是物体快闪

  snapshot_points   JSON              轨迹快照          (可选)
                                                        存储触发报警时刻的关键坐标点数组，用于前端缩略图展示
  ------------------------------------------------------------------------------------------------------------

### 1.4 待下发指令表 (pending_commands)

实现"指令缓存区"功能。由于 ESP32
无法被动接收请求，所有控制指令必须先写入此表。

  -----------------------------------------------------------------------
  **字段名**        **类型**          **说明**          **备注**
  ----------------- ----------------- ----------------- -----------------
  id                BigInt            主键              

  device_mac        Varchar(17)       目标设备          

  command_type      Varchar(20)       指令类型          \'REBOOT\',
                                                        \'SET_MODE\',
                                                        \'SET_ZONE\'

  payload           JSON              指令参数          如区域坐标数据

  status            Enum              状态              \'PENDING\'
                                                        (待取), \'SENT\'
                                                        (已下发),
                                                        \'EXECUTED\'
                                                        (已执行)

  created_at        DateTime          创建时间          
  -----------------------------------------------------------------------

**索引策略:**

- idx_mac_status: (device_mac, status) -\> 用于 API
  快速查找该设备当前是否有未处理的 PENDING 指令。
