# HLK-LD.2450 智能雷达可视化前端设计文档 (V1.0.1)

## 1. 页面功能模块规划

本系统采用响应式 Web 设计，分为 **实时态势 (Live)**、**守卫预警
(Guard)**、**历史回溯 (History)** 和 **设备配置 (Settings)**
四大核心模块。

### 1.1 实时态势仪表盘 (Live Dashboard)

- **可视化扇形图**：使用 Canvas 绘制 \$\\pm 60\^\\circ\$、半径 6
  米的扇形区域 1-3。

- **多目标追踪**：以不同颜色的圆点实时渲染最多 3 个目标（Target 1-3），根据设备当前模式动态显示（单目标模式仅显示T1，多目标模式显示全部） 3,
  4。

- **动态浮窗**：点击目标点显示实时 X/Y 坐标、速度及距离 3, 5。

- **上传频率指示**：显示当前 ESP32 的上报状态（待机 1Hz / 活跃 10Hz） 6,
  7。

### 1.2 守卫模式 (Guardian Mode) ------ **新增核心逻辑**

该模块利用雷达的"区域检测"能力 8, 9，实现安全监控功能。

- **预警区域设置**：用户可在扇形图上直接点击拖动，划定最多 **3
  个矩形预警区**（对应雷达内部指令 0x00C2） 9-11。

- **警戒时间轴**：设置每日警戒时段（如 22:00 - 06:00）。

- **入侵节点展示**：当在警戒时间内目标进入预警区，系统从数据库
  radar_tracking_logs 调取该时间点数据 12, 13，在页面右侧时间轴显示：

- **入侵快照**：展示目标当时的 X/Y 坐标位置分布。

- **持续时长**：目标在区域内停留的总秒数。

- **实时推送机制**：当 active_viewers \> 0
  且触发入侵时，前端界面产生红色闪烁报警 6, 14。

### 1.3 历史回溯与统计 (Analytics) ------ **新增核心逻辑**

- **轨迹重放 (Path Replay)**：

- 通过 API /api/v1/radar/history 获取指定时间段的坐标点位 12。

- 在扇形图上以"淡入淡出"的尾迹线展示目标的移动路线，支持 1x/2x/4x
  速度回放。

- **空间占用热力图 (Heatmap)**：

- 统计数据库内一段周期（如 24 小时）的所有位置点。

- 将 6
  米扇形区划分为若干网格，根据点位密度渲染颜色，直观显示哪个位置是人员高频活动区（如家中的办公椅、沙发区）。

### 1.4 设备高级控制 (Control Panel)

- **模式切换**：单目标/多目标追踪模式一键下发（指令 0x0080/0x0090）
  15-17。

- **蓝牙开关**：控制雷达蓝牙功能的开启/关闭，并提示用户需重启生效 10,
  18, 19。

- **系统诊断**：实时显示 ESP32 的固件版本、MAC
  地址、最后一次心跳时间及在线状态 14, 20。

## 2. 核心算法与交互逻辑

### 2.1 坐标转换公式 (Radar to Canvas)

雷达上报的是以自身为原点的直角坐标 (X, Y)，单位 mm 21,
22。前端需按照以下比例尺映射至网页像素 17：

- **坐标含义**：X=0代表雷达视角正前方有人，X>0代表左侧，X<0代表右侧。Y代表的距离，恒为正，单位为毫米。

- **画布原点**：设 Canvas 宽度 \$W\$，高度 \$H\$。原点 \$(0, 0)\$ 对应
  Canvas 底部中心 \$(W/2, H)\$ 17。

- **转换公式**：

- screenX = (W / 2) + (x_mm \* Scale)

- screenY = H - (y_mm \* Scale)

- 其中 Scale = H / 6000 (基于 6 米最大量程) 17。

### 2.2 实时加速通信流 (Active Sync)

为保证前端查看时的"丝滑感"，系统遵循以下流程 6, 7：

1.  **用户进入**：前端打开 Web 页面，通过 WebSocket 连接服务器。

2.  **触发加速**：服务器检测到当前该 MAC 地址有活跃观察者，在 ESP32 下次
    HTTP Sync 时，通过响应体告知其 interval: 100ms 6。

3.  **高频渲染**：前端通过 WebSocket 接收 10Hz 的 JSON 数据包，使用
    requestAnimationFrame 确保 Canvas 渲染不掉帧 6。

4.  **用户离开**：关闭页面后，服务器自动调低 ESP32 上传频率至 1Hz 6。

## 3. 前端 API 调用规划 (供开发参考)

功能模块,API 路径,方法,说明

实时流,/ws/radar/live?mac={id},WS,获取 10Hz 实时坐标推送（后端需实现WebSocket支持） 6

历史回溯,/api/v1/radar/history,GET,\"参数：start_time, end_time。获取历史轨迹点（后端需实现） 12\"

守卫日志,/api/v1/guard/events,GET,获取入侵报警的历史列表与坐标节点（后端需实现） 13

设备状态,/api/v1/device/status,GET,获取ESP32固件版本、MAC、最后心跳时间及在线状态（后端需实现） 14, 20

下发指令,/api/v1/device/command,POST,\"存储待执行指令（重启、切模式、设预警区，后端需实现pending_commands处理） 14, 20\"


---

## 更新日志 (V1.0.1)

- **坐标解析修复**：后端parseCoordinate函数已修正，确保Y坐标为正值，符合坐标转换公式。
- **数据过滤优化**：后端device_sync已过滤无效目标（x=y=speed=resolution=0），前端无需额外处理无效数据。
- **单/多目标模式**：前端需根据设备模式动态显示目标数量（单目标仅T1，多目标最多3个）。
- **API规划更新**：统一历史回溯API路径为/api/v1/radar/history，添加设备状态API /api/v1/device/status。
- **后端实现需求**：需实现WebSocket实时流、历史查询、守卫事件、设备状态和指令下发API。
